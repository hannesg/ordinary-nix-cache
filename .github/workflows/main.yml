on: [push]

jobs:
  nix-build:
    runs-on: ubuntu-latest
    name: Test caching works
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@main
      - name: Setup Cache
        uses: ./
      - name: Nix build
        run: nix-build --expr 'derivation { name = "dummy"; builder = "/bin/sh"; system = builtins.currentSystem;  args = ["-c" "echo ${{github.sha}} > $out"];}'
      - name: Delete local nix cache
        run: |
          mv result old-result
          nix-store --delete ./old-result
      - name: Nix build again
        run: nix-build --max-jobs 0 --expr 'derivation { name = "dummy"; builder = "/bin/sh"; system = builtins.currentSystem;  args = ["-c" "echo ${{github.sha}} > $out"];}'
